<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direktori Jasa - IndoMY</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">IndoMY</a>
            <div class="nav-links">
                <a href="services.html">Direktori Jasa</a>
                <a href="articles.html">Artikel</a>
                <a href="submit-service.html">Tambah Jasa</a>
                <a href="submit-article.html">Tulis Artikel</a>
            </div>
        </div>
    </nav>

    <div class="page-header">
        <div class="container">
            <h1>Direktori Jasa</h1>
            <p>Temukan berbagai jasa terpercaya dari komunitas</p>
        </div>
    </div>

    <main class="container">
        <!-- Search & Filter -->
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Cari jasa atau nama...">
                <button onclick="searchServices()" class="btn btn-primary">Cari</button>
            </div>
            <div class="filter-tags" id="categoryFilters">
                <span class="filter-tag active" data-category="all">Semua</span>
                <span class="filter-tag" data-category="Locksmith">ğŸ”‘ Tukang Kunci</span>
                <span class="filter-tag" data-category="Cleaner">ğŸ§¹ Jasa Kebersihan</span>
                <span class="filter-tag" data-category="Driver">ğŸš— Driver/Sopir</span>
                <span class="filter-tag" data-category="Money Changer">ğŸ’° Money Changer</span>
                <span class="filter-tag" data-category="Restaurant">ğŸœ Restoran</span>
                <span class="filter-tag" data-category="Car Rental">ğŸš™ Sewa Mobil</span>
                <span class="filter-tag" data-category="Travel">âœˆï¸ Travel Agent</span>
                <span class="filter-tag" data-category="Lawyer">âš–ï¸ Pengacara</span>
                <span class="filter-tag" data-category="Doctor">ğŸ¥ Dokter</span>
                <span class="filter-tag" data-category="Contractor">ğŸ”¨ Kontraktor</span>
            </div>
        </div>

        <!-- Results -->
        <div id="servicesContainer" class="grid grid-3">
            <div class="loading">Memuat direktori...</div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 IndoMY - Komunitas Indonesia di Malaysia</p>
        </div>
    </footer>

    <script>
        let currentPage = 1;
        let currentCategory = 'all';
        let currentSearch = '';
        const itemsPerPage = 12;
        let allServices = [];

        async function loadServices() {
            try {
                allServices = await ServicesAPI.getApproved();
                filterAndDisplayServices();
            } catch (error) {
                document.getElementById('servicesContainer').innerHTML = 
                    '<div class="loading">Gagal memuat data. Refresh halaman.</div>';
            }
        }

        function filterAndDisplayServices() {
            let filtered = [...allServices];
            
            // Filter by category
            if (currentCategory !== 'all') {
                filtered = filtered.filter(s => s.category === currentCategory);
            }
            
            // Filter by search
            if (currentSearch) {
                const search = currentSearch.toLowerCase();
                filtered = filtered.filter(s => 
                    s.name.toLowerCase().includes(search) ||
                    s.description.toLowerCase().includes(search)
                );
            }
            
            // Paginate
            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedServices = filtered.slice(start, start + itemsPerPage);
            
            // Display
            const container = document.getElementById('servicesContainer');
            
            if (paginatedServices.length === 0) {
                container.innerHTML = '<div class="loading">Tidak ada jasa ditemukan</div>';
            } else {
                container.innerHTML = paginatedServices.map(service => {
                    const stars = renderStars(service.average_rating);
                    return `
                        <div class="card">
                            <div class="card-body">
                                <span class="category">${service.category}</span>
                                <h3><a href="service-detail.html?id=${service.id}">${service.name}</a></h3>
                                <div class="rating">${stars} (${service.reviews_count || 0} ulasan)</div>
                                <p>${service.description.substring(0, 120)}...</p>
                                <small>ğŸ“ ${service.area || 'Malaysia'}</small>
                                <div style="margin-top: 1rem;">
                                    <a href="service-detail.html?id=${service.id}" class="btn btn-small">Lihat Detail</a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update pagination
            renderPagination(totalPages);
        }

        function renderStars(avg) {
            if (!avg) return 'â˜†â˜†â˜†â˜†â˜†';
            const full = Math.floor(avg);
            const half = avg - full >= 0.5 ? 1 : 0;
            const empty = 5 - full - half;
            return 'â˜…'.repeat(full) + (half ? 'Â½' : '') + 'â˜†'.repeat(empty);
        }

        function renderPagination(totalPages) {
            if (totalPages <= 1) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            document.getElementById('pagination').innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            filterAndDisplayServices();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function searchServices() {
            currentSearch = document.getElementById('searchInput').value;
            currentPage = 1;
            filterAndDisplayServices();
        }

        // Category filter click handlers
        document.querySelectorAll('.filter-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                tag.classList.add('active');
                currentCategory = tag.dataset.category;
                currentPage = 1;
                filterAndDisplayServices();
            });
        });

        // Enter key search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchServices();
        });

        loadServices();
    </script>
</body>
</html>