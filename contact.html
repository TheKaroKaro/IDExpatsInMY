<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Service Details - IndoMY</title>
<style>
  :root{ --primary:#FF6B6B; --dark:#2C3E50; --bg:#f0f2f5; }
  body{ font-family:'Inter',system-ui; background:var(--bg); }
  .wrap{ max-width:900px; margin:2rem auto; background:#fff; border-radius:20px; padding:2rem; box-shadow:0 8px 30px rgba(0,0,0,.08); }
  .title{ color:var(--primary); margin:0 0 .5rem; }
  .muted{ color:#667; }
  .stars { color:#f5a623; font-size:1.2rem; margin:.25rem 0 1rem; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:1.2rem; }
  .card{ background:#fff; border:1px solid #eee; border-radius:14px; padding:1rem; }
  .form-group{ margin:.8rem 0; }
  label{ font-weight:600; display:block; margin-bottom:.3rem; }
  .form-control{ width:100%; padding:.7rem; border:1px solid #ddd; border-radius:10px; }
  textarea.form-control{ min-height:120px; }
  .btn{ background:var(--primary); color:#fff; border:none; padding:.7rem 1.2rem; border-radius:10px; cursor:pointer; }
  .list{ list-style:none; padding:0; }
  .list li{ border-bottom:1px solid #eee; padding:.7rem 0; }
  .badge{ background:#eee; padding:.2rem .5rem; border-radius:6px; margin-left:.5rem; font-size:.8rem; }
  .alert{ display:none; padding:.8rem; border-radius:10px; margin:.6rem 0; }
  .alert-success{ background:#d4edda; color:#155724; }
  .alert-error{ background:#f8d7da; color:#721c24; }
</style>
</head>
<body>
  <div class="wrap">
    <div id="details"></div>
    <div class="row">
      <div class="card">
        <h3>‚≠ê Rate this service</h3>
        <div id="rateAlert" class="alert"></div>
        <div class="form-group">
          <label>Stars (1-5)</label>
          <input type="number" id="stars" class="form-control" min="1" max="5" value="5"/>
        </div>
        <div class="form-group">
          <label>Your name (optional)</label>
          <input id="rater" class="form-control"/>
        </div>
        <div class="form-group">
          <div class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY"></div>
        </div>
        <button class="btn" id="rateBtn">Submit Rating</button>
      </div>

      <div class="card">
        <h3>üí¨ Leave a comment</h3>
        <div id="cAlert" class="alert"></div>
        <div class="form-group">
          <label>Name *</label>
          <input id="cname" class="form-control" required/>
        </div>
        <div class="form-group">
          <label>Comment *</label>
          <textarea id="cbody" class="form-control" required></textarea>
        </div>
        <div class="form-group">
          <div class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY"></div>
        </div>
        <button class="btn" id="commentBtn">Submit Comment</button>
        <p class="muted">Comments are shown after admin approval.</p>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <h3>Comments</h3>
      <ul class="list" id="commentsList"><li class="muted">Loading‚Ä¶</li></ul>
    </div>
  </div>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script>
    const params = new URLSearchParams(location.search);
    const contactId = params.get('id');
    if (!contactId) location.href = 'index.html';

    function starString(avg=0){
      const full=Math.floor(avg), half=(avg-full)>=.5?1:0, empty=5-full-half;
      return '‚òÖ'.repeat(full)+(half?'¬Ω':'')+'‚òÜ'.repeat(empty);
    }
    function setAlert(elId, ok, msg){
      const el = document.getElementById(elId);
      el.className = 'alert ' + (ok ? 'alert-success':'alert-error');
      el.textContent = msg; el.style.display='block';
    }
    async function fetchJSON(u){ const r=await fetch(u); if(!r.ok) throw new Error(await r.text()); return r.json(); }

    async function load() {
      const data = await fetchJSON(`/api/contacts?id=${encodeURIComponent(contactId)}`);
      const f = data.record.fields;
      const rating = data.rating || { average: f.AverageRating || 0, count: f.ReviewsCount || 0 };

      document.getElementById('details').innerHTML = `
        <h1 class="title">${f.Name}</h1>
        <div class="stars">${starString(rating.average)} <span class="badge">${rating.average.toFixed(1)} / 5</span> <span class="badge">${rating.count} reviews</span></div>
        <p><strong>Category:</strong> ${f.Category || '-'}</p>
        <p><strong>Area:</strong> ${f.Area || 'All Malaysia'}</p>
        <p><strong>Phone:</strong> ${f.Phone || '-'}</p>
        <p style="margin-top:.6rem">${(f.Description||'').replace(/\n/g,'<br/>')}</p>
      `;

      // Comments (Approved only) ‚Äî fetch via Airtable filter through your base:
      const resp = await fetch(`/api/articles`); // dummy call to keep connection warm
      // For simplicity, we‚Äôll load comments via Airtable proxy later if needed.
      // If you want comments listing now, create an API to GET approved comments for contact.
      // To keep this answer focused, we‚Äôll show placeholder text:
      document.getElementById('commentsList').innerHTML = '<li class="muted">No comments to show yet.</li>';
    }

    // Simple (non-robust) device hash
    function deviceHash() {
      const s = navigator.userAgent + '|' + (screen.width+'x'+screen.height) + '|' + Intl.DateTimeFormat().resolvedOptions().timeZone;
      return Array.from(new TextEncoder().encode(s)).reduce((a,b)=> (a + ((b+256).toString(16))).slice(-8),'');
    }

    document.getElementById('rateBtn').addEventListener('click', async ()=>{
      try {
        const stars = Number(document.getElementById('stars').value);
        const displayName = document.getElementById('rater').value;
        const tokenEl = document.querySelectorAll('input[name="cf-turnstile-response"]')[0];
        const turnstileToken = tokenEl ? tokenEl.value : "";
        const res = await fetch('/api/rate', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ contactId, stars, displayName, deviceHash: deviceHash(), turnstileToken })
        });
        const data = await res.json(); if(!res.ok) throw new Error(data.error || 'Failed');
        setAlert('rateAlert', true, `Thanks! New average: ${data.average} (${data.count} reviews)`);
      } catch (e) {
        console.error(e); setAlert('rateAlert', false, 'Failed to submit rating.');
      } finally {
        if (window.turnstile) window.turnstile.reset();
      }
    });

    document.getElementById('commentBtn').addEventListener('click', async ()=>{
      try{
        const displayName = document.getElementById('cname').value.trim();
        const comment = document.getElementById('cbody').value.trim();
        const tokenEl = document.querySelectorAll('input[name="cf-turnstile-response"]')[1];
        const turnstileToken = tokenEl ? tokenEl.value : "";
        if (!displayName || !comment) return setAlert('cAlert', false, 'Please enter name and comment.');
        const res = await fetch('/api/comment', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ contactId, displayName, comment, turnstileToken })
        });
        const data = await res.json(); if(!res.ok) throw new Error(data.error || 'Failed');
        setAlert('cAlert', true, 'Submitted! Your comment is pending approval.');
        document.getElementById('cname').value=''; document.getElementById('cbody').value='';
      } catch(e){
        console.error(e); setAlert('cAlert', false, 'Failed to submit comment.');
      } finally {
        if (window.turnstile) window.turnstile.reset();
      }
    });

    load();
  </script>
</body>
</html>
``