<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Jasa - IndoMY</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        :root { --primary: #FF6B6B; --secondary: #4ECDC4; --dark: #2C3E50; --light: #f8f9fa; }
        body { background: var(--light); color: var(--dark); line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
        
        nav { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 1rem 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); text-decoration: none; }
        
        .service-detail { background: white; border-radius: 15px; padding: 2rem; margin: 2rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .service-header { margin-bottom: 2rem; }
        .service-category { color: var(--secondary); font-weight: 600; text-transform: uppercase; font-size: 0.9rem; }
        .service-name { font-size: 2rem; color: var(--primary); margin: 0.5rem 0; }
        .service-rating { display: flex; align-items: center; gap: 1rem; margin: 1rem 0; }
        .stars { color: #FFD700; font-size: 1.2rem; }
        .rating-number { font-weight: 600; }
        .contact-info { background: var(--light); padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0; }
        .contact-item { margin: 0.5rem 0; }
        .contact-item a { color: var(--primary); text-decoration: none; }
        
        .action-buttons { display: flex; gap: 1rem; margin: 2rem 0; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close { font-size: 1.5rem; cursor: pointer; }
        .form-group { margin: 1rem 0; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-control { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; }
        .star-rating { display: flex; gap: 0.5rem; font-size: 2rem; color: #ddd; cursor: pointer; }
        .star-rating .selected { color: #FFD700; }
        
        .comments-section { margin-top: 2rem; }
        .comment { border-bottom: 1px solid #eee; padding: 1rem 0; }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .comment-name { font-weight: 600; }
        .comment-date { color: #999; font-size: 0.9rem; }
        .alert { padding: 1rem; border-radius: 5px; margin: 1rem 0; display: none; }
        .alert-success { background: #d4edda; color: #155724; display: block; }
        .alert-error { background: #f8d7da; color: #721c24; display: block; }
        
        @media (max-width: 768px) {
            .action-buttons { flex-direction: column; }
        }
    </style>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">IndoMY</a>
        </div>
    </nav>

    <main class="container">
        <div id="serviceDetail" class="service-detail">
            <div class="loading">Memuat detail jasa...</div>
        </div>

        <!-- Rating Modal -->
        <div class="modal" id="ratingModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Beri Rating</h2>
                    <span class="close" onclick="closeModal('ratingModal')">&times;</span>
                </div>
                <div id="ratingAlert" class="alert"></div>
                <form id="ratingForm">
                    <div class="form-group">
                        <label>Rating</label>
                        <div class="star-rating" id="starRating">
                            <span data-value="1">‚òÜ</span>
                            <span data-value="2">‚òÜ</span>
                            <span data-value="3">‚òÜ</span>
                            <span data-value="4">‚òÜ</span>
                            <span data-value="5">‚òÜ</span>
                        </div>
                        <input type="hidden" id="ratingValue" value="0">
                    </div>
                    <div class="form-group">
                        <label>Nama (opsional)</label>
                        <input type="text" id="ratingName" class="form-control" placeholder="Anonymous">
                    </div>
                    <div class="form-group">
                        <div class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Kirim Rating</button>
                </form>
            </div>
        </div>

        <!-- Comment Modal -->
        <div class="modal" id="commentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Tulis Komentar</h2>
                    <span class="close" onclick="closeModal('commentModal')">&times;</span>
                </div>
                <div id="commentAlert" class="alert"></div>
                <form id="commentForm">
                    <div class="form-group">
                        <label>Nama *</label>
                        <input type="text" id="commentName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Komentar *</label>
                        <textarea id="commentText" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <div class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Kirim Komentar</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        const serviceId = new URLSearchParams(location.search).get('id');
        if (!serviceId) location.href = '/services.html';

        let currentService = null;

        async function loadServiceDetail() {
            try {
                const res = await fetch(`/api/services?id=${serviceId}`);
                const data = await res.json();
                currentService = data.record;
                
                const f = currentService.fields;
                const stars = renderStars(f.AverageRating);
                
                document.getElementById('serviceDetail').innerHTML = `
                    <div class="service-header">
                        <span class="service-category">${f.Category}</span>
                        <h1 class="service-name">${f.Name}</h1>
                        <div class="service-rating">
                            <span class="stars">${stars}</span>
                            <span class="rating-number">${f.AverageRating?.toFixed(1) || '0.0'} (${f.ReviewsCount || 0} ulasan)</span>
                        </div>
                    </div>
                    
                    <div class="contact-info">
                        <div class="contact-item"><strong>üìû Telepon:</strong> <a href="tel:${f.Phone}">${f.Phone}</a></div>
                        ${f.WhatsApp ? `<div class="contact-item"><strong>üí¨ WhatsApp:</strong> <a href="https://wa.me/${f.WhatsApp.replace(/[^0-9]/g, '')}">${f.WhatsApp}</a></div>` : ''}
                        ${f.Area ? `<div class="contact-item"><strong>üìç Area:</strong> ${f.Area}</div>` : ''}
                        ${f.Address ? `<div class="contact-item"><strong>üè† Alamat:</strong> ${f.Address}</div>` : ''}
                    </div>
                    
                    <div class="service-description">
                        <h3>Deskripsi</h3>
                        <p>${f.Description.replace(/\n/g, '<br>')}</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('ratingModal')">‚≠ê Beri Rating</button>
                        <button class="btn btn-secondary" onclick="openModal('commentModal')">üí¨ Tulis Komentar</button>
                    </div>
                    
                    <div class="comments-section">
                        <h3>Komentar</h3>
                        <div id="commentsList">Memuat komentar...</div>
                    </div>
                `;
                
                loadComments();
                
            } catch (error) {
                document.getElementById('serviceDetail').innerHTML = '<div class="loading">Gagal memuat detail jasa</div>';
            }
        }

        function renderStars(avg) {
            if (!avg) return '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
            const full = Math.floor(avg);
            const half = avg - full >= 0.5 ? 1 : 0;
            const empty = 5 - full - half;
            return '‚òÖ'.repeat(full) + (half ? '¬Ω' : '') + '‚òÜ'.repeat(empty);
        }

        async function loadComments() {
            try {
                // Note: You'll need to add a GET endpoint for comments
                // For now, show placeholder
                document.getElementById('commentsList').innerHTML = '<p>Belum ada komentar. Jadilah yang pertama berkomentar!</p>';
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (window.turnstile) window.turnstile.reset();
        }

        // Star rating handler
        document.addEventListener('click', (e) => {
            if (e.target.closest('#starRating span')) {
                const stars = document.querySelectorAll('#starRating span');
                const value = parseInt(e.target.dataset.value);
                
                stars.forEach((star, index) => {
                    if (index < value) {
                        star.textContent = '‚òÖ';
                        star.classList.add('selected');
                    } else {
                        star.textContent = '‚òÜ';
                        star.classList.remove('selected');
                    }
                });
                
                document.getElementById('ratingValue').value = value;
            }
        });

        // Rating form submit
        document.getElementById('ratingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const stars = parseInt(document.getElementById('ratingValue').value);
            if (stars === 0) {
                showAlert('ratingAlert', 'Pilih rating terlebih dahulu', false);
                return;
            }
            
            const token = document.querySelector('[name="cf-turnstile-response"]')?.value;
            
            try {
                const res = await fetch('/api/ratings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serviceId,
                        stars,
                        displayName: document.getElementById('ratingName').value || 'Anonymous',
                        turnstileToken: token
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showAlert('ratingAlert', 'Rating berhasil dikirim!', true);
                    setTimeout(() => {
                        closeModal('ratingModal');
                        loadServiceDetail(); // Reload to show updated rating
                    }, 1500);
                } else {
                    showAlert('ratingAlert', data.error || 'Gagal mengirim rating', false);
                }
            } catch (error) {
                showAlert('ratingAlert', 'Gagal mengirim rating', false);
            }
        });

        // Comment form submit
        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = document.querySelectorAll('[name="cf-turnstile-response"]')[1]?.value;
            
            try {
                const res = await fetch('/api/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serviceId,
                        displayName: document.getElementById('commentName').value,
                        comment: document.getElementById('commentText').value,
                        turnstileToken: token
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showAlert('commentAlert', 'Komentar berhasil dikirim dan menunggu persetujuan!', true);
                    setTimeout(() => {
                        closeModal('commentModal');
                        document.getElementById('commentForm').reset();
                    }, 1500);
                } else {
                    showAlert('commentAlert', data.error || 'Gagal mengirim komentar', false);
                }
            } catch (error) {
                showAlert('commentAlert', 'Gagal mengirim komentar', false);
            }
        });

        function showAlert(elementId, message, isSuccess) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.className = `alert ${isSuccess ? 'alert-success' : 'alert-error'}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        };

        loadServiceDetail();
    </script>
</body>
</html>